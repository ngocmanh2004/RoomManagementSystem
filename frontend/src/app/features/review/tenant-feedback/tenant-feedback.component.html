<div class="container mx-auto p-6 max-w-5xl">
  <div class="text-center mb-10">
    <div class="feedback-create-section">
      <div>
        <h3>G·ª≠i ph·∫£n h·ªìi m·ªõi</h3>
        <p>B√°o c√°o s·ª± c·ªë, y√™u c·∫ßu s·ª≠a ch·ªØa ho·∫∑c g√≥p √Ω c·∫£i thi·ªán</p>
      </div>
      <button class="btn-create" (click)="toggleCreateForm()">
        {{ showCreateForm ? 'ƒê√≥ng form' : '+ T·∫°o ph·∫£n h·ªìi' }}
      </button>
    </div>

  <div class="feedback-wrapper mx-auto">
    <!-- KHUNG NGO√ÄI B·ªåC FORM -->
    <div *ngIf="showCreateForm" class="feedback-create-form-wrapper">

      <!-- Alert th√¥ng b√°o -->
      <div *ngIf="alertMessage" class="feedback-alert" [class.success]="alertType==='success'" 
          [class.error]="alertType==='error'" [class.info]="alertType==='info'">
        <div class="flex items-center gap-3">
          <span class="text-2xl">
            <span *ngIf="alertType==='success'">üéâ</span>
            <span *ngIf="alertType==='error'">‚ùå</span>
            <span *ngIf="alertType==='info'">‚ÑπÔ∏è</span>
          </span>
          <span class="font-medium">{{ alertMessage }}</span>
        </div>
        <button (click)="alertMessage = ''">‚úï</button>
      </div>

      <form novalidate (ngSubmit)="submit()" #f="ngForm" class="space-y-8">

        <!-- Ti√™u ƒë·ªÅ -->
        <div>
          <label class="feedback-form-label">Ti√™u ƒë·ªÅ <span class="text-error">*</span></label>
          <input type="text"
                [(ngModel)]="newFeedback.title"
                name="title"
                required
                class="feedback-form-input"
                placeholder="VD: ·ªêng n∆∞·ªõc h·ªèng, WiFi y·∫øu..." />
        </div>

        <!-- N·ªôi dung -->
        <div>
          <label class="feedback-form-label">N·ªôi dung chi ti·∫øt <span class="text-error">*</span></label>
          <textarea [(ngModel)]="newFeedback.content"
                    name="content"
                    rows="5"
                    required
                    class="feedback-form-textarea"
                    placeholder="M√¥ t·∫£ r√µ v·∫•n ƒë·ªÅ b·∫°n ƒëang g·∫∑p..."></textarea>
        </div>

        <!-- Upload ·∫£nh -->
        <div class="feedback-upload-section">
          <label class="feedback-upload-label">·∫¢nh ƒë√≠nh k√®m (t√πy ch·ªçn)</label>
          <input type="file"
                accept="image/*"
                (change)="onFileSelected($event)"
                class="feedback-file-input" />

          <!-- Preview ·∫£nh -->
          <div *ngIf="selectedFile" class="feedback-preview-container">
            <img *ngIf="previewUrl" [src]="previewUrl" alt="Preview" class="feedback-preview-img" />
            <div class="feedback-preview-info">
              <p>{{ selectedFile.name }}</p>
              <p>{{ formatFileSize(selectedFile.size) }}</p>
            </div>
            <button type="button" class="feedback-remove-btn" (click)="removeFile()">
              X√≥a ·∫£nh
            </button>
          </div>
        </div>

        <!-- N√∫t g·ª≠i -->
        <div class="feedback-submit-section">
          <button type="submit"
                  class="feedback-submit-btn"
                  [disabled]="loading || f.invalid">
            <span *ngIf="loading" class="loading loading-spinner mr-2"></span>
            {{ loading ? 'ƒêang g·ª≠i...' : 'G·ª≠i ph·∫£n h·ªìi ngay' }}
          </button>

          <p class="feedback-error-message" 
            *ngIf="submitted && (!newFeedback.title.trim() || !newFeedback.content.trim())">
            Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung
          </p>
        </div>

      </form>
    </div>

    <!-- L·ªãch s·ª≠ ph·∫£n h·ªìi -->
    <div class="mt-12">

      <!-- Khi ch∆∞a c√≥ ph·∫£n h·ªìi -->
      <div *ngIf="myFeedback.length === 0" class="text-center py-20 text-gray-500">
        <p class="text-xl">B·∫°n ch∆∞a g·ª≠i ph·∫£n h·ªìi n√†o</p>
      </div>

      <!-- B·∫¢NG KHI C√ì D·ªÆ LI·ªÜU -->
      <div *ngIf="myFeedback.length > 0" class="bg-base-100 feedback-card overflow-x-auto">
        
        <div class="space-y-6">

          <div *ngFor="let fb of myFeedback" class="feedback-card-item">

            <!-- Ti√™u ƒë·ªÅ ri√™ng m·ªôt d√≤ng -->
            <div class="feedback-card-header">
              <h4>{{ fb.title }}</h4>
            </div>

            
            <div class="feedback-status-row">
              <span class="feedback-status-badge" [ngClass]="getStatusClass(fb.status)">
                {{ getStatusText(fb.status) }}
              </span>
              <div class="feedback-timestamp">
                T·∫°o {{ fb.createdAt | date:'HH:mm dd/MM/yyyy' }}
                <span *ngIf="fb.updatedAt"> ‚Ä¢ C·∫≠p nh·∫≠t {{ fb.updatedAt | date:'HH:mm dd/MM/yyyy' }}</span>
              </div>
            </div>

            <!-- N·ªôi dung -->
            <p class="feedback-content">{{ fb.content }}</p>

            <!-- ·∫¢nh n·∫øu c√≥ -->
            <img 
              *ngIf="fb.attachmentUrl"
              [src]="safeImageUrl(fb.attachmentUrl)"
              (click)="openImageModal(fb.attachmentUrl)"
              class="feedback-image"
            />

            <!-- Ph·∫£n h·ªìi ch·ªß tr·ªç -->
            <div *ngIf="fb.landlordNote" class="feedback-landlord-reply">
              <p>Ph·∫£n h·ªìi t·ª´ ch·ªß tr·ªç</p>
              <p>{{ fb.landlordNote }}</p>
            </div>
            <!-- N√∫t x√°c nh·∫≠n H√†i l√≤ng / Ch∆∞a h√†i l√≤ng -->
          <div *ngIf="fb.landlordNote && fb.status === 'RESOLVED'" class="feedback-confirmation">
            <button class="btn btn-success btn-sm" (click)="confirmSatisfied(fb.id)">H√†i l√≤ng ‚úÖ</button>
            <button class="btn btn-warning btn-sm" (click)="openRejectBox(fb.id)">Ch∆∞a h√†i l√≤ng ‚ùå</button>
          </div>
          <!-- Form nh·∫≠p l√Ω do ch∆∞a h√†i l√≤ng -->
          <div *ngIf="showRejectBoxId === fb.id" class="feedback-reject-box">
            <textarea [(ngModel)]="rejectReason" placeholder="Nh·∫≠p l√Ω do ch∆∞a h√†i l√≤ng..."></textarea>
            <button class="btn btn-primary btn-sm" (click)="submitReject()">G·ª≠i</button>
            <button class="btn btn-secondary btn-sm" (click)="closeRejectBox()">H·ªßy</button>
          </div>

        </div>
        <!-- Ph√¢n trang -->
        <div *ngIf="totalPages > 1" class="flex justify-center mt-4 gap-2">
          <button class="btn btn-sm" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
            ¬´ Tr∆∞·ªõc
          </button>

          <button *ngFor="let page of pages"
                  class="btn btn-sm"
                  [ngClass]="{'btn-primary': currentPage === page, 'btn-outline': currentPage !== page}"
                  (click)="goToPage(page)">
            {{ page }}
          </button>

          <button class="btn btn-sm" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
            Ti·∫øp ¬ª
          </button>
        </div>
      </div>
    </div>
  </div>
</div>