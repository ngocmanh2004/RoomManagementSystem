<div class="container mx-auto p-6 max-w-5xl">
  <div class="text-center mb-10">
    <h2 class="text-4xl font-bold text-primary mb-3">G·ª≠i ph·∫£n h·ªìi / Khi·∫øu n·∫°i</h2>
    <p class="text-gray-600">Ch·ªß tr·ªç lu√¥n s·∫µn s√†ng h·ªó tr·ª£ b·∫°n</p>
  </div>

  <div class="feedback-wrapper mx-auto">
    <!-- KHUNG NGO√ÄI B·ªåC FORM -->
    <div class="bg-base-100 feedback-card mb-12">
      <!-- ALERT MESSAGE -->
      <div *ngIf="alertMessage" 
           class="alert alert-{{alertType}} mb-6 animate-pulse shadow-lg">
        <div class="flex items-center gap-2">
          <span *ngIf="alertType === 'success'" class="text-2xl">üéâ</span>
          <span *ngIf="alertType === 'error'" class="text-2xl">‚ùå</span>
          <span *ngIf="alertType === 'info'" class="text-2xl">‚ÑπÔ∏è</span>
          <span class="font-medium">{{alertMessage}}</span>
        </div>
        <button class="btn btn-sm btn-circle btn-ghost ml-auto" 
                (click)="alertMessage = ''">‚úï</button>
      </div>
      <form novalidate (ngSubmit)="submit()" #f="ngForm" class="space-y-6 feedback-form">
        <!-- Th√™m ph·∫ßn hi·ªÉn th·ªã alert ·ªü ƒë·∫ßu form -->
        <div *ngIf="alertMessage" class="alert alert-{{alertType}} mb-4">
          <span>{{alertMessage}}</span>
          <button class="btn btn-sm btn-circle btn-ghost" (click)="alertMessage = ''">‚úï</button>
        </div>
        <!-- TI√äU ƒê·ªÄ -->
        <div class="form-row">
          <label>Ti√™u ƒë·ªÅ <span class="text-error">*</span></label>
          <input type="text"
                 [(ngModel)]="newFeedback.title"
                 name="title"
                 required
                 class="input input-bordered input-lg"
                 placeholder="VD: ·ªêng n∆∞·ªõc h·ªèng, WiFi y·∫øu..." />
        </div>
        
        <!-- N·ªòI DUNG -->
        <div class="form-row">
          <label>N·ªôi dung chi ti·∫øt <span class="text-error">*</span></label>
          <textarea [(ngModel)]="newFeedback.content"
                    name="content"
                    rows="4"
                    required
                    class="textarea textarea-bordered"
                    placeholder="M√¥ t·∫£ r√µ v·∫•n ƒë·ªÅ b·∫°n ƒëang g·∫∑p..."></textarea>
        </div>
        
        <!-- FILE -->
        <div class="form-row">
          <label>·∫¢nh ƒë√≠nh k√®m</label>
          <input
            type="file"
            accept="image/*"
            (change)="onFileSelected($event)"
            class="file-input file-input-bordered" />
          <!-- PREVIEW ·∫¢NH -->
            <div *ngIf="selectedFile" class="mt-4">
            <div class="flex flex-col sm:flex-row items-center gap-4 p-4 bg-base-200 rounded-xl border border-base-300">
                <img
                    [src]="previewUrl"
                    class="preview-img cursor-pointer"
                    alt="Preview" />

                <!-- Th√¥ng tin file + n√∫t x√≥a -->
                <div class="flex-1 text-center sm:text-left">
                <p class="font-medium text-sm">{{ selectedFile.name }}</p>
                <p class="text-xs text-gray-500 mt-1">{{ formatFileSize(selectedFile.size) }}</p>
                </div>

                <!-- N√∫t x√≥a g·ªçn g√†ng -->
                <button type="button"
                        class="btn btn-sm btn-error btn-outline"
                        (click)="removeFile()">
                X√≥a ·∫£nh
                </button>
            </div>
          </div>
        </div>

        <!-- N√öT -->
        <div class="text-center pt-6">
          <button type="submit" class="btn btn-primary btn-lg" 
                  [disabled]="loading || f.invalid"
                  [ngClass]="{'btn-disabled': f.invalid && f.touched}">
            <span *ngIf="loading" class="loading loading-spinner"></span>
            {{ loading ? 'ƒêang g·ª≠i...' : 'G·ª≠i ph·∫£n h·ªìi ngay' }}
          </button>
          <div class="text-center pt-2">
            <p class="text-error text-sm" 
              *ngIf="submitted && (!newFeedback.title.trim() || !newFeedback.content.trim())">
              Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc
            </p>
          </div>
        </div>
      </form>
    </div>

    <!-- L·ªãch s·ª≠ ph·∫£n h·ªìi -->
    <div class="mt-12">
      <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
        L·ªãch s·ª≠ ph·∫£n h·ªìi c·ªßa b·∫°n
        <span class="badge badge-lg badge-primary">{{ myFeedback.length }}</span>
      </h3>

      <!-- Khi ch∆∞a c√≥ ph·∫£n h·ªìi -->
      <div *ngIf="myFeedback.length === 0" class="text-center py-20 text-gray-500">
        <p class="text-xl">B·∫°n ch∆∞a g·ª≠i ph·∫£n h·ªìi n√†o</p>
      </div>

      <!-- B·∫¢NG KHI C√ì D·ªÆ LI·ªÜU -->
      <div *ngIf="myFeedback.length > 0" class="bg-base-100 feedback-card overflow-x-auto">
        <table class="table table-zebra w-full">
          <!-- Header -->
          <thead>
            <tr class="bg-gradient-to-r from-primary/10 to-secondary/10 text-left text-sm font-bold uppercase tracking-wider">
              <th class="px-6 py-5">N·ªôi dung</th>
              <th class="px-6 py-5">Ph√≤ng</th>
              <th class="px-6 py-5">G·ª≠i l√∫c</th>
              <th class="px-6 py-5">Tr·∫°ng th√°i</th>
              <th class="px-6 py-5 text-center">H√†nh ƒë·ªông</th>
            </tr>
          </thead>

          <!-- Body -->
          <tbody class="bg-base-100">
            <tr *ngFor="let fb of myFeedback" class="hover:bg-base-200 transition-all duration-200 border-b border-base-300">
              <!-- Ti√™u ƒë·ªÅ + N·ªôi dung + Ghi ch√∫ ch·ªß tr·ªç -->
              <td class="px-6 py-5">
                <div class="font-semibold text-primary">{{ fb.title }}</div>
                <div class="text-sm text-gray-600 mt-1 max-w-md line-clamp-2">{{ fb.content }}</div>
                
                <!-- HI·ªÇN TH·ªä ·∫¢NH ƒê√çNH K√àM -->
                <div *ngIf="fb.attachmentUrl" class="mt-3">
                  <p class="text-xs font-medium text-gray-500 mb-1">·∫¢nh ƒë√≠nh k√®m:</p>
                  <img
                    [src]="fb.attachmentUrl"
                    alt="·∫¢nh ƒë√≠nh k√®m"
                    class="feedback-image"
                    (click)="openImageModal(fb.attachmentUrl)">
                </div>
                
                <!-- GHI CH√ö CH·ª¶ TR·ªå  -->
                <div *ngIf="fb.landlordNote" class="mt-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                  <span class="font-medium text-blue-800 text-xs">Ch·ªß tr·ªç:</span>
                  <span class="text-blue-900 text-sm ml-1">{{ fb.landlordNote }}</span>
                </div>
              </td>

              <!-- Ph√≤ng -->
              <td class="px-6 py-5">
                <div class="font-medium">{{ fb.room && fb.room.name ? fb.room.name : '‚Äî' }}</div>
              </td>

              <!-- Th·ªùi gian -->
              <td class="px-6 py-5 text-sm">
                <div>{{ fb.createdAt | date:'dd/MM/yyyy' }}</div>
                <div class="text-gray-500">{{ fb.createdAt | date:'HH:mm' }}</div>
                <div *ngIf="fb.resolvedAt" class="text-xs text-success mt-1">
                  X·ª≠ l√Ω: {{ fb.resolvedAt | date:'dd/MM HH:mm' }}
                </div>
              </td>

              <!-- Tr·∫°ng th√°i -->
              <td class="px-6 py-5">
                <div class="badge badge-lg font-bold" [ngClass]="getStatusClass(fb.status)">
                  {{ getStatusText(fb.status) }}
                </div>
              </td>

              <!-- H√†nh ƒë·ªông -->
              <td class="px-6 py-5 text-center">
                <div class="flex flex-col items-center gap-2">
                  <!-- Khi ƒë√£ x·ª≠ l√Ω xong (RESOLVED) -->
                  <div *ngIf="fb.status === 'RESOLVED'">
                    <button class="btn btn-success btn-sm mb-2"
                            (click)="confirmSatisfied(fb.id)">
                      H√†i l√≤ng
                    </button>

                    <button class="btn btn-error btn-outline btn-sm"
                            (click)="openRejectBox(fb.id)">
                      Ch∆∞a h√†i l√≤ng
                    </button>

                    <!-- Khung ph·∫£n h·ªìi l·∫°i -->
                    <div *ngIf="showRejectBoxId === fb.id" class="mt-4 p-3 bg-base-200 rounded-lg">
                      <textarea
                        [(ngModel)]="rejectReason"
                        class="textarea textarea-bordered w-full h-20 text-sm"
                        placeholder="N√™u l√Ω do b·∫°n ch∆∞a h√†i l√≤ng...">
                      </textarea>
                      
                      <div class="flex justify-end gap-2 mt-2">
                        <button class="btn btn-ghost btn-xs"
                                (click)="closeRejectBox()">
                          H·ªßy
                        </button>
                        <button class="btn btn-error btn-xs"
                                (click)="submitReject()"
                                [disabled]="!rejectReason.trim()">
                          G·ª≠i ph·∫£n h·ªìi
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Khi ch∆∞a x·ª≠ l√Ω ho·∫∑c ƒëang x·ª≠ l√Ω -->
                  <div *ngIf="fb.status === 'PENDING' || fb.status === 'PROCESSING' || fb.status === 'TENANT_REJECTED'">
                    <button 
                        class="btn btn-ghost btn-sm text-error delete-btn"
                        (click)="deleteFeedback(fb.id)">
                      üóë X√≥a
                    </button>
                  </div>

                  <!-- Tr·∫°ng th√°i cu·ªëi -->
                  <div *ngIf="fb.status === 'TENANT_CONFIRMED'" class="text-success font-bold">
                    ƒê√£ ho√†n t·∫•t
                  </div>

                  <div *ngIf="fb.status === 'TENANT_REJECTED'" class="text-warning font-medium">
                    ƒê√£ ph·∫£n h·ªìi l·∫°i
                  </div>

                  <div *ngIf="fb.status === 'CANCELED'" class="text-gray-400 italic">
                    ƒê√£ h·ªßy
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <!-- Ph√¢n trang -->
        <div *ngIf="totalPages > 1" class="flex justify-center mt-4 gap-2">
          <button class="btn btn-sm" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
            ¬´ Tr∆∞·ªõc
          </button>

          <button *ngFor="let page of pages"
                  class="btn btn-sm"
                  [ngClass]="{'btn-primary': currentPage === page, 'btn-outline': currentPage !== page}"
                  (click)="goToPage(page)">
            {{ page }}
          </button>

          <button class="btn btn-sm" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
            Ti·∫øp ¬ª
          </button>
        </div>
      </div>
    </div>
  </div>
</div>