<!-- PAGE SHELL -->
<div class="page">
  <!-- Top bar -->
  <div class="topbar">
    <div>
      <h1>T·ªïng h·ª£p H√≥a ƒë∆°n</h1>
      <p class="sub">T·∫°o v√† qu·∫£n l√Ω h√≥a ƒë∆°n h√†ng th√°ng cho kh√°ch thu√™</p>
    </div>

    <div class="topbar-actions">
      <button class="btn outline">‚úÖ ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ tr·∫£</button>
      <button class="btn primary" (click)="openCreateModal()">+ T·∫°o h√≥a ƒë∆°n th√°ng</button>
    </div>
  </div>

  <!-- KPI CARDS -->
  <div class="grid grid-4 gap">
    <div class="card kpi">
      <div class="icon blue">‚Ç´</div>
      <div class="kpi-body">
        <div class="label">T·ªïng s·ªë ti·ªÅn ch∆∞a thanh to√°n</div>
        <div class="value">{{ stats().totalAmount | currency: 'VND' }}</div>
      </div>
    </div>

    <div class="card kpi">
      <div class="icon emerald">‚úì</div>
      <div class="kpi-body">
        <div class="label">ƒê√£ thanh to√°n</div>
        <div class="value">{{ stats().paidCount }}</div>
      </div>
    </div>

    <div class="card kpi">
      <div class="icon amber">‚óã</div>
      <div class="kpi-body">
        <div class="label">Ch∆∞a thanh to√°n</div>
        <div class="value">{{ stats().unpaidCount }}</div>
      </div>
    </div>

    <div class="card kpi">
      <div class="icon rose">!</div>
      <div class="kpi-body">
        <div class="label">Qu√° h·∫°n</div>
        <div class="value">{{ stats().overdueCount }}</div>
      </div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="card filters">
    <div class="filter-grid">
      <label class="field">
        <span>Th√°ng</span>
        <select [value]="filters().month" (change)="onFilterMonthChange($event)">
          <option value="">T·∫•t c·∫£ th√°ng</option>
          <option *ngFor="let month of months()" [value]="month">
            T{{ month.split('-')[1] }}/{{ month.split('-')[0] }}
          </option>
        </select>
      </label>

      <label class="field">
        <span>H·ª£p ƒê·ªìng</span>
        <select [value]="filters().contractId" (change)="onFilterContractChange($event)">
          <option value="0">T·∫•t c·∫£ h·ª£p ƒë·ªìng</option>
          <option *ngFor="let contract of contracts()" [value]="contract.id">
            {{ contract.contractCode }} - {{ contract.fullName }}
          </option>
        </select>
      </label>

      <label class="field">
        <span>Tr·∫°ng Th√°i</span>
        <select [value]="filters().status" (change)="onFilterStatusChange($event)">
          <option value="ALL">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="UNPAID">Ch∆∞a thanh to√°n</option>
          <option value="PAID">ƒê√£ thanh to√°n</option>
          <option value="OVERDUE">Qu√° h·∫°n</option>
        </select>
      </label>

      <label class="field">
        <span>T√¨m ki·∫øm</span>
        <input type="text" placeholder="T·ª´ kh√≥a..." [value]="filters().keyword" (input)="onFilterKeywordChange($event)" />
      </label>
    </div>

    <div class="filter-actions">
      <button class="btn primary" (click)="openCreateModal()">+ T·∫°o H√≥a ƒê∆°n M·ªõi</button>
    </div>
  </div>

  <!-- CHARTS ROW -->
  <div class="grid grid-2 gap">
    <!-- So s√°nh ƒêi·ªán - N∆∞·ªõc -->
    <div class="card">
      <div class="card-head">
        <h3>So s√°nh ƒêi·ªán - N∆∞·ªõc theo Ph√≤ng</h3>
      </div>

      <div class="cmp-list">
        <div class="cmp-item" *ngFor="let invoice of filteredInvoices() | slice:0:5">
          <div class="cmp-title">
            <span class="room">{{ invoice.roomName }}</span>
            <span class="meta">
              ƒêi·ªán: {{ invoice.electricity | currency: 'VND' }} ¬∑
              N∆∞·ªõc: {{ invoice.water | currency: 'VND' }}
            </span>
          </div>

          <!-- hai thanh ti·∫øn tr√¨nh m√¥ ph·ªèng ·∫£nh -->
          <div class="cmp-bars">
            <div class="prog">
              <div class="bar blue"
                   [style.width]="(invoice.electricity / (invoice.electricity + invoice.water + 1)) * 100 + '%'">
              </div>
            </div>

            <div class="prog small">
              <div class="bar cyan"
                   [style.width]="(invoice.water / (invoice.electricity + invoice.water + 1)) * 100 + '%'">
              </div>
            </div>
          </div>
        </div>

        <div class="muted" *ngIf="(filteredInvoices() || []).length === 0">
          Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ so s√°nh.
        </div>
      </div>
    </div>

    <!-- C∆° c·∫•u Chi ph√≠ -->
    <div class="card">
      <div class="card-head">
        <h3>C∆° c·∫•u Chi ph√≠</h3>
      </div>

      <div class="donut-wrap">
        <div class="donut"
             [style.background]="
               'conic-gradient(#2563eb ' + (stats().electricityPct || 40) + '%, ' +
               '#06b6d4 0 ' + ((stats().electricityPct || 40) + (stats().waterPct || 20)) + '%, ' +
               '#f97316 0)'">
          <div class="donut-hole">
            <div class="donut-center">
              <div class="center-label">T·ªïng</div>
              <div class="center-value">{{ stats().totalAmount | currency: 'VND' }}</div>
            </div>
          </div>
        </div>

        <div class="legend">
          <div class="lg-item"><span class="dot blue"></span> ƒêi·ªán</div>
          <div class="lg-item"><span class="dot cyan"></span> N∆∞·ªõc</div>
          <div class="lg-item"><span class="dot orange"></span> Kh√°c</div>
          <div class="legend-note">* Bi·ªÉu ƒë·ªì minh h·ªça t·ªâ tr·ªçng chi ph√≠.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card table-card">
    <table>
      <thead>
        <tr>
          <th>M√£ H·ª£p ƒê·ªìng</th>
          <th>Ph√≤ng</th>
          <th>Kh√°ch Thu√™</th>
          <th>Th√°ng</th>
          <th class="text-right">Ti·ªÅn Ph√≤ng</th>
          <th class="text-right">Ti·ªÅn ƒêi·ªán</th>
          <th class="text-right">Ti·ªÅn N∆∞·ªõc</th>
          <th class="text-right">Chi Ph√≠ Kh√°c</th>
          <th class="text-right">T·ªïng Ti·ªÅn</th>
          <th class="text-center">Tr·∫°ng Th√°i</th>
          <th class="text-center">H√†nh ƒê·ªông</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let invoice of filteredInvoices()">
          <td>{{ invoice.contractCode }}</td>
          <td>{{ invoice.roomName }}</td>
          <td>{{ invoice.tenantName }}</td>
          <td>T{{ invoice.month.split('-')[1] }}/{{ invoice.month.split('-')[0] }}</td>
          <td class="text-right">{{ invoice.roomRent | currency: 'VND' }}</td>
          <td class="text-right">{{ invoice.electricity | currency: 'VND' }}</td>
          <td class="text-right">{{ invoice.water | currency: 'VND' }}</td>
          <td class="text-right">{{ invoice.extraCost | currency: 'VND' }}</td>
          <td class="text-right strong">{{ invoice.totalAmount | currency: 'VND' }}</td>
          <td class="text-center">
            <span [ngClass]="getStatusClass(invoice.status)" class="badge">
              {{ getStatusLabel(invoice.status) }}
            </span>
          </td>
          <td class="text-center nowrap">
            <button class="act edit" (click)="editInvoice(invoice)" title="Ch·ªânh S·ª≠a">‚úèÔ∏è</button>
            <button class="act pay"
                    (click)="updateInvoiceStatus(invoice, invoice.status === 'PAID' ? 'UNPAID' : 'PAID')"
                    title="C·∫≠p Nh·∫≠t Thanh To√°n">
              {{ invoice.status === 'PAID' ? '‚úì' : '‚óã' }}
            </button>
            <button class="act delete" (click)="deleteInvoice(invoice)" title="X√≥a">üóëÔ∏è</button>
          </td>
        </tr>

        <tr *ngIf="filteredInvoices().length === 0">
          <td colspan="11" class="empty">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†o ph√π h·ª£p</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CREATE / EDIT MODAL -->
<div *ngIf="isModalOpen()" class="modal-bg">
  <div class="modal">
    <header>
      <h2>{{ isEditMode() ? 'Ch·ªânh S·ª≠a H√≥a ƒê∆°n' : 'T·∫°o H√≥a ƒê∆°n M·ªõi' }}</h2>
    </header>

    <div class="content">
      <div class="form-grid">
        <div class="col-2">
          <label>H·ª£p ƒê·ªìng *</label>
          <select
            [value]="form().contractId"
            (change)="onFormContractChange($event)"
            [disabled]="isEditMode()">
            <option value="0">Ch·ªçn h·ª£p ƒë·ªìng</option>
            <option *ngFor="let contract of contracts()" [value]="contract.id">
              {{ contract.contractCode }} - {{ contract.fullName }}
            </option>
          </select>
        </div>

        <div>
          <label>Th√°ng *</label>
          <input type="month"
                 [value]="form().month"
                 (change)="onFormMonthChange($event)"
                 [disabled]="isEditMode()" />
        </div>

        <div>
          <label>Ti·ªÅn Ph√≤ng</label>
          <input type="number" min="0" step="1000"
                 [value]="form().roomRent"
                 (change)="updateFormField('roomRent', +($event.target as HTMLInputElement).value)"
                 [disabled]="!isEditMode()" />
        </div>

        <div>
          <label>Ti·ªÅn ƒêi·ªán</label>
          <input type="number" min="0" step="1000"
                 [value]="form().electricity"
                 (change)="onFormElectricityChange($event)"
                 [disabled]="!isEditMode()" />
        </div>

        <div>
          <label>Ti·ªÅn N∆∞·ªõc</label>
          <input type="number" min="0" step="1000"
                 [value]="form().water"
                 (change)="onFormWaterChange($event)"
                 [disabled]="!isEditMode()" />
        </div>

        <div>
          <label>Chi Ph√≠ Kh√°c</label>
          <input type="number" min="0" step="1000"
                 [value]="form().extraCost"
                 (change)="onFormExtraCostChange($event)"
                 [disabled]="!isEditMode()" />
        </div>

        <div class="col-2">
          <label>Ghi Ch√∫</label>
          <textarea rows="3" [value]="form().notes" (change)="onFormNotesChange($event)"></textarea>
        </div>
      </div>
    </div>

    <footer>
      <button class="btn outline" (click)="closeModal()">H·ªßy</button>
      <button class="btn primary" (click)="saveInvoice()">
        {{ isEditMode() ? 'C·∫≠p Nh·∫≠t' : 'T·∫°o' }}
      </button>
    </footer>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div *ngIf="isConfirmModalOpen()" class="modal-bg">
  <div class="modal small">
    <header><h2>X√°c Nh·∫≠n</h2></header>

    <div class="content">
      <p class="mb">
        B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën
        <strong>{{ actionType() === 'PAY' ? 'ƒë√°nh d·∫•u ƒë√£ thanh to√°n' : 'ƒë√°nh d·∫•u ch∆∞a thanh to√°n' }}</strong>
        h√≥a ƒë∆°n n√†y?
      </p>

      <div class="summary">
        <div><b>Ph√≤ng:</b> {{ invoiceToConfirm()?.roomName }}</div>
        <div><b>Kh√°ch:</b> {{ invoiceToConfirm()?.tenantName }}</div>
        <div *ngIf="invoiceToConfirm()?.month as month"><b>Th√°ng:</b> T{{ month.split('-')[1] }}</div>
        <div *ngIf="invoiceToConfirm()?.totalAmount as total"><b>T·ªïng:</b> {{ invoiceToConfirm()?.totalAmount | currency: 'VND' }}</div>
      </div>
    </div>

    <footer>
      <button class="btn outline" (click)="cancelAction()">H·ªßy</button>
      <button class="btn primary" (click)="confirmAction()">X√°c Nh·∫≠n</button>
    </footer>
  </div>
</div>
