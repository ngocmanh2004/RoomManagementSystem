<div class="notification-page">

<div class="notification-card modern-card">

  <h3 class="notification-title modern-title">G·ª≠i th√¥ng b√°o cho kh√°ch</h3>

  <div class="notification-body" [formGroup]="form">

    <!-- TI√äU ƒê·ªÄ -->
    <div class="field-group">
      <label class="form-label">Ti√™u ƒë·ªÅ</label>
      <input type="text" class="form-control" formControlName="title" />
    </div>

    <!-- N·ªòI DUNG -->
    <div class="field-group">
      <label class="form-label">N·ªôi dung</label>
      <textarea class="form-control" rows="5" formControlName="message"></textarea>
    </div>

    <!-- ƒê·ªêI T∆Ø·ª¢NG -->
    <div class="field-group">
      <label class="form-label">ƒê·ªëi t∆∞·ª£ng</label>
      <select class="form-control" formControlName="sendTo">
        <option value="ALL_TENANTS">To√†n b·ªô kh√°ch</option>
        <option value="ROOMS">Ch·ªçn ph√≤ng</option>
        <option value="USERS">Ch·ªçn kh√°ch</option>
      </select>
    </div>
     <!-- ====================== PH·∫¶N CH·ªåN PH√íNG ====================== -->
    <div *ngIf="form.get('sendTo')?.value === 'ROOMS'" class="room-selection-container">
      <label class="form-label">Ch·ªçn ph√≤ng</label>
      <!-- Khu v·ª±c hi·ªÉn th·ªã ph√≤ng ƒë√£ ch·ªçn -->
      <div class="selected-rooms-container" (click)="openRoomSelector = true">
        <span *ngIf="selectedRoomIds.length === 0" class="selected-rooms-placeholder">
          Nh·∫•n ƒë·ªÉ ch·ªçn ph√≤ng...
        </span>
        
        <div *ngFor="let roomId of selectedRoomIds" class="room-chip">
          {{ getRoomName(roomId) }}
          <button type="button" class="remove-room-btn" 
                  (click)="removeRoom(roomId); $event.stopPropagation()">√ó</button>
        </div>
      </div>
      <!-- Popup ch·ªçn ph√≤ng -->
      <div class="room-selector-popup" *ngIf="openRoomSelector">
        <div class="popup-header">
          <strong>Ch·ªçn ph√≤ng</strong>
          <button type="button" class="close-popup-btn" (click)="openRoomSelector = false">√ó</button>
        </div>
        
        <div class="room-list">
          <!-- Loading state -->
          <div *ngIf="loadingRooms" class="rooms-loading">
            <div class="loading-spinner"></div>
            <div>ƒêang t·∫£i danh s√°ch ph√≤ng...</div>
          </div>
          <!-- Danh s√°ch ph√≤ng -->
          <div
                *ngFor="let room of rooms"
                class="room-item"
                (click)="toggleRoom(room.id, !isRoomSelected(room.id))"
              >
            <div class="room-checkbox-container">
              <input
                type="checkbox"
                [checked]="isRoomSelected(room.id)"
                (click)="$event.stopPropagation()"
              />
              <span class="room-checkbox-custom"></span>
            </div>
            <div class="room-info">
              <div class="room-name">{{ room.name }}</div>
              <div *ngIf="room.area || room.price" class="room-details">
                <span *ngIf="room.area">{{ room.area }}m¬≤</span>
                <span *ngIf="room.price"> ‚Ä¢ {{ room.price | currency:'VND' }}/th√°ng</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="popup-footer">
          <button type="button" class="done-btn" (click)="openRoomSelector = false">
            Xong ({{ selectedRoomIds.length }} ph√≤ng)
          </button>
        </div>
      </div>
      <!-- Overlay khi m·ªü popup -->
      <div class="popup-overlay" *ngIf="openRoomSelector" 
           (click)="openRoomSelector = false"></div>
    </div>
  
    <!-- ====================== PH·∫¶N CH·ªåN KH√ÅCH THU√ä ====================== -->
<div *ngIf="form.get('sendTo')?.value === 'USERS'" class="user-selection-container">
  <label class="form-label">Ch·ªçn kh√°ch thu√™</label>
  
  <!-- Khu v·ª±c hi·ªÉn th·ªã kh√°ch ƒë√£ ch·ªçn -->
  <div class="selected-users-container" (click)="openUserSelector = true">
    <span *ngIf="selectedUserIds.length === 0" class="selected-users-placeholder">
      Nh·∫•n ƒë·ªÉ ch·ªçn kh√°ch...
    </span>
    
    <div *ngFor="let userId of selectedUserIds" class="user-chip">
      {{ getUserName(userId) }}
      <button type="button" class="remove-user-btn" 
              (click)="removeUser(userId); $event.stopPropagation()">√ó</button>
    </div>
  </div>
  
  <!-- Popup ch·ªçn kh√°ch -->
  <div class="user-selector-popup" *ngIf="openUserSelector">
    <div class="popup-header">
      <strong>Ch·ªçn kh√°ch</strong>
      <button type="button" class="close-popup-btn" (click)="openUserSelector = false">√ó</button>
    </div>
    
    <div class="user-list">
      <!-- Loading state -->
      <div *ngIf="loadingTenants" class="users-loading">
        <div class="loading-spinner"></div>
        <div>ƒêang t·∫£i danh s√°ch kh√°ch...</div>
      </div>
      
      <!-- Danh s√°ch kh√°ch -->
      <div
          *ngFor="let user of tenants"
          class="user-item"
          (click)="toggleUser(user.id, !isUserSelected(user.id))"
        >
        <div class="user-checkbox-container">
          <input
            type="checkbox"
            [checked]="isUserSelected(user.id)"
            (click)="$event.stopPropagation()"
          />
          <span class="user-checkbox-custom"></span>
        </div>
        <div class="user-info">
          <div class="user-name">{{ user.fullName || user.username }}</div>
          <div class="user-details">
            <span *ngIf="user.email">{{ user.email }}</span>
            <span *ngIf="user.phone"> ‚Ä¢ {{ user.phone }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="popup-footer">
      <button type="button" class="done-btn" (click)="openUserSelector = false">
        ƒê√£ ch·ªçn: {{ selectedUserIds.length }} ‚Ä¢ T·ªïng: {{ tenants.length }} kh√°ch
      </button>
    </div>
  </div>
  
  <!-- Overlay khi m·ªü popup -->
  <div class="popup-overlay" *ngIf="openUserSelector" 
       (click)="openUserSelector = false"></div>
</div>

    <!-- G·ª¨I EMAIL -->
    <div class="field-group checkbox-group">
      <input class="form-check-input" type="checkbox" id="sendEmail" formControlName="sendEmail" />
      <label class="form-check-label" for="sendEmail">G·ª≠i email k√®m (n·∫øu c√≥)</label>
    </div>

    <!-- N√öT G·ª¨I -->
    <button type="button" class="btn btn-primary w-100" 
            (click)="send()" 
            [disabled]="sending || form.invalid">
      {{ sending ? 'ƒêang g·ª≠i...' : 'G·ª≠i' }}
    </button>

    <!-- K·∫æT QU·∫¢ -->
    <div *ngIf="alertMessage" class="alert mt-3" 
         [ngClass]="alertType === 'success' ? 'alert-success' : 'alert-error'">
      <strong>{{ alertMessage }}</strong>
    </div>
  </div>
  </div>
</div>
<div *ngIf="activeTab === 'feedback'" class="empty-state">
  <i>üì≠</i>
  <p>Ch∆∞a c√≥ ph·∫£n h·ªìi n√†o</p>
</div>
