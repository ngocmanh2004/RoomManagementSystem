<div class="notification-card">
  <h3 class="notification-title">Gửi thông báo cho khách</h3>

  <div class="notification-body" [formGroup]="form">

    <!-- TIÊU ĐỀ -->
    <div class="field-group">
      <label class="form-label">Tiêu đề</label>
      <input type="text" class="form-control" formControlName="title" />
    </div>

    <!-- NỘI DUNG -->
    <div class="field-group">
      <label class="form-label">Nội dung</label>
      <textarea class="form-control" rows="5" formControlName="message"></textarea>
    </div>

    <!-- ĐỐI TƯỢNG -->
    <div class="field-group">
      <label class="form-label">Đối tượng</label>
      <select class="form-control" formControlName="sendTo">
        <option value="ALL">Toàn bộ khách</option>
        <option value="ROOMS">Chọn phòng</option>
        <option value="USERS">Chọn khách</option>
      </select>
    </div>
     <!-- ====================== PHẦN CHỌN PHÒNG ====================== -->
    <div *ngIf="form.get('sendTo')?.value === 'ROOMS'" class="room-selection-container">
      <label class="form-label">Chọn phòng</label>
      <!-- Khu vực hiển thị phòng đã chọn -->
      <div class="selected-rooms-container" (click)="openRoomSelector = true">
        <span *ngIf="selectedRoomIds.length === 0" class="selected-rooms-placeholder">
          Nhấn để chọn phòng...
        </span>
        
        <div *ngFor="let roomId of selectedRoomIds" class="room-chip">
          {{ getRoomName(roomId) }}
          <button type="button" class="remove-room-btn" 
                  (click)="removeRoom(roomId); $event.stopPropagation()">×</button>
        </div>
      </div>
      <!-- Popup chọn phòng -->
      <div class="room-selector-popup" *ngIf="openRoomSelector">
        <div class="popup-header">
          <strong>Chọn phòng</strong>
          <button type="button" class="close-popup-btn" (click)="openRoomSelector = false">×</button>
        </div>
        
        <div class="room-list">
          <!-- Loading state -->
          <div *ngIf="loadingRooms" class="rooms-loading">
            <div class="loading-spinner"></div>
            <div>Đang tải danh sách phòng...</div>
          </div>
          <!-- Danh sách phòng -->
          <div *ngFor="let room of rooms" class="room-item" 
               (click)="toggleRoom(room.id, !selectedRoomIds.includes(room.id))">
            <div class="room-checkbox-container">
              <input type="checkbox" [checked]="selectedRoomIds.includes(room.id)">
              <span class="room-checkbox-custom"></span>
            </div>
            <div class="room-info">
              <div class="room-name">{{ room.name }}</div>
              <div *ngIf="room.area || room.price" class="room-details">
                <span *ngIf="room.area">{{ room.area }}m²</span>
                <span *ngIf="room.price"> • {{ room.price | currency:'VND' }}/tháng</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="popup-footer">
          <button type="button" class="done-btn" (click)="openRoomSelector = false">
            Xong ({{ selectedRoomIds.length }} phòng)
          </button>
        </div>
      </div>
      <!-- Overlay khi mở popup -->
      <div class="popup-overlay" *ngIf="openRoomSelector" 
           (click)="openRoomSelector = false"></div>
    </div>
    <!-- ====================== PHẦN CHỌN KHÁCH THUÊ ====================== -->
<div *ngIf="form.get('sendTo')?.value === 'USERS'" class="user-selection-container">
  <label class="form-label">Chọn khách thuê</label>
  
  <!-- Khu vực hiển thị khách đã chọn -->
  <div class="selected-users-container" (click)="openUserSelector = true">
    <span *ngIf="selectedUserIds.length === 0" class="selected-users-placeholder">
      Nhấn để chọn khách...
    </span>
    
    <div *ngFor="let userId of selectedUserIds" class="user-chip">
      {{ getUserName(userId) }}
      <button type="button" class="remove-user-btn" 
              (click)="removeUser(userId); $event.stopPropagation()">×</button>
    </div>
  </div>
  
  <!-- Popup chọn khách -->
  <div class="user-selector-popup" *ngIf="openUserSelector">
    <div class="popup-header">
      <strong>Chọn khách</strong>
      <button type="button" class="close-popup-btn" (click)="openUserSelector = false">×</button>
    </div>
    
    <div class="user-list">
      <!-- Loading state -->
      <div *ngIf="loadingTenants" class="users-loading">
        <div class="loading-spinner"></div>
        <div>Đang tải danh sách khách...</div>
      </div>
      
      <!-- Danh sách khách -->
      <div *ngFor="let user of tenants" class="user-item" 
           (click)="toggleUser(user.id, !selectedUserIds.includes(user.id))">
        <div class="user-checkbox-container">
          <input type="checkbox" [checked]="selectedUserIds.includes(user.id)">
          <span class="user-checkbox-custom"></span>
        </div>
        <div class="user-info">
          <div class="user-name">{{ user.fullName || user.username }}</div>
          <div class="user-details">
            <span *ngIf="user.email">{{ user.email }}</span>
            <span *ngIf="user.phone"> • {{ user.phone }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="popup-footer">
      <button type="button" class="done-btn" (click)="openUserSelector = false">
        Đã chọn: {{ selectedUserIds.length }} • Tổng: {{ tenants.length }} khách
      </button>
    </div>
  </div>
  
  <!-- Overlay khi mở popup -->
  <div class="popup-overlay" *ngIf="openUserSelector" 
       (click)="openUserSelector = false"></div>
</div>

    <!-- GỬI EMAIL -->
    <div class="field-group checkbox-group">
      <input class="form-check-input" type="checkbox" id="sendEmail" formControlName="sendEmail" />
      <label class="form-check-label" for="sendEmail">Gửi email kèm (nếu có)</label>
    </div>

    <!-- NÚT GỬI -->
    <button type="button" class="btn btn-primary w-100" 
            (click)="send()" 
            [disabled]="sending || form.invalid">
      {{ sending ? 'Đang gửi...' : 'Gửi' }}
    </button>

    <!-- KẾT QUẢ -->
    <div *ngIf="alertMessage" class="alert mt-3" 
         [ngClass]="alertType === 'success' ? 'alert-success' : 'alert-error'">
      <strong>{{ alertMessage }}</strong>
    </div>
  </div>
</div>